<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CSV to Chart</title>
    <script src="https://unpkg.com/lightweight-charts@3.0.0/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <div id="container" ></div>

    <script>
        // 从HTML文件中获取CSV文件的路径
        const csvFilePath = './bitcoin-marketcap-residual-week.csv';

        // 使用Papa Parse库解析CSV文件
        Papa.parse(csvFilePath, {
            download: true,
            header: true,
            complete: function(results) {
                const BitcoinMarketCapLogData = results.data.map((row) => ({
                    time: row.time,
                    value: row['Bitcoin-MarketCap-Log'],
                    residual: row.Residual,
                }));
                const ResidualData = results.data.map((row) => ({
                    time: row.time,
                    value: row.Residual,
                }));

                // 将解析后的数据传递给lightweight-charts库以绘制面积图
                const chart = LightweightCharts.createChart(document.getElementById('container'), {
                    width: 600,
                    height: 300,
                });

                const  BitcoinMarketCapLogSeries = chart.addAreaSeries({
                    topColor: 'rgba(38, 198, 218, 0.56)',
                    bottomColor: 'rgba(38, 198, 218, 0.04)',
                    lineColor: 'rgba(38, 198, 218, 1)',
                    lineWidth: 2,
                    //title: '比特币市值对数'
                });

                BitcoinMarketCapLogSeries.setData(BitcoinMarketCapLogData);
                const ResidualSeries = chart.addAreaSeries({
                    topColor: 'rgba(255, 0, 0, 0.56)',
                    bottomColor: 'rgba(255, 0, 0, 0.04)',
                    lineColor: 'rgba(255, 0, 0, 1)',
                    lineWidth: 2,
                    //title: '误差值'
                });

                ResidualSeries.setData(ResidualData);
                chart.timeScale().fitContent();
                // add price line
                const myPriceLine1 = {
                    price: -0.85,
                    color: '#3179F5',
                    lineWidth: 2,
                    lineStyle: 2, // LineStyle.Dashed
                    axisLabelVisible: true,
                    //title: '买入提示',
                };
                ResidualSeries.createPriceLine(myPriceLine1);
                const myPriceLine2 = {
                    price: 1,
                    color: 'red',
                    lineWidth: 2,
                    lineStyle: 2, // LineStyle.Dashed
                    axisLabelVisible: true,
                    //title: '卖出提示',
                };
                ResidualSeries.createPriceLine(myPriceLine2);
                
                // add legend
                const symbolName = '比特币市值对数 ';

                const container = document.getElementById('container');

                const legend = document.createElement('div');
                legend.style = "position: absolute; left: 12px; top: 12px; z-index: 1; font-size: 14px; font-family: sans-serif; line-height: 18px; font-weight: 300";
                container.appendChild(legend);

                const firstRow = document.createElement('div');
                firstRow.innerHTML = symbolName;
                firstRow.style.color = 'rgba(38, 198, 218, 1)';
                legend.appendChild(firstRow);
                // 在legend后面显示数据
                chart.subscribeCrosshairMove(param => {
                    let priceFormatted = '';
                    if (param.time) {
                        const dateStr = param.time;
                        const data = param.seriesData.get(BitcoinMarketCapLogSeries);
                        const price = data.value !== undefined ? data.value : data.close;
                        priceFormatted = price.toFixed(2);
                        toolTip.style.display = 'block';
                        toolTip.innerHTML = `<div>${priceFormatted}</div>
                    <div>${dateStr}</div>`;
                        // Position tooltip according to mouse cursor position
                        toolTip.style.left = param.point.x - 50 + 'px';
                        toolTip.style.top = param.point.y - 50 + 'px';

                    }
                    firstRow.innerHTML = `${symbolName} <strong>`;

                })
            },
        });
    </script>
</body>
</html>